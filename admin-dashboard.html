<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - ã‚¢ã‚µãƒãƒ€ãƒ³ã‚¹ã‚¹ã‚¯ãƒ¼ãƒ«</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold text-gray-800">ã‚¢ã‚µãƒãƒ€ãƒ³ã‚¹ã‚¹ã‚¯ãƒ¼ãƒ«</h1>
        <p class="text-sm text-gray-600">ç®¡ç†ç”»é¢</p>
      </div>
      <div class="flex items-center space-x-4">
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="mb-8">
      <div class="flex space-x-1 bg-white rounded-lg p-1 shadow-sm overflow-x-auto">
        <button class="nav-btn active px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap" data-section="dashboard">
          ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap" data-section="calendar">
          ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap" data-section="bookings">
          äºˆç´„ç®¡ç†
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap" data-section="staff">
          ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap" data-section="schedule">
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        </button>
      </div>
    </nav>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="dashboardSection" class="section">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="text-sm text-gray-600 mb-2">ä»Šæ—¥ã®äºˆç´„</div>
          <div class="text-3xl font-bold text-blue-600" id="todayBookings">0</div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="text-sm text-gray-600 mb-2">ä»Šé€±ã®äºˆç´„</div>
          <div class="text-3xl font-bold text-green-600" id="weekBookings">0</div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="text-sm text-gray-600 mb-2">ç·äºˆç´„æ•°</div>
          <div class="text-3xl font-bold text-gray-800" id="totalBookings">0</div>
        </div>
      </div>

      <!-- æœ€è¿‘ã®äºˆç´„ -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">æœ€è¿‘ã®äºˆç´„</h2>
        </div>
        <div id="recentBookings" class="p-6">
          <p class="text-gray-500 text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div id="calendarSection" class="section hidden">
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b flex justify-between items-center">
          <button id="prevMonth" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">
            â† å‰æœˆ
          </button>
          <h2 class="text-lg font-bold" id="currentMonth"></h2>
          <button id="nextMonth" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">
            æ¬¡æœˆ â†’
          </button>
        </div>
        <div class="p-6">
          <div id="calendarGrid" class="grid grid-cols-7 gap-2">
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>

      <!-- é¸æŠã—ãŸæ—¥ã®äºˆç´„è©³ç´° -->
      <div id="dayDetails" class="mt-6 bg-white rounded-lg shadow hidden">
        <div class="p-6 border-b">
          <h3 class="text-lg font-bold" id="selectedDate"></h3>
        </div>
        <div id="dayBookings" class="p-6">
          <!-- äºˆç´„è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>

    <!-- äºˆç´„ç®¡ç† -->
    <div id="bookingsSection" class="section hidden">
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">äºˆç´„ä¸€è¦§</h2>
        </div>
        <div id="allBookings" class="p-6">
          <p class="text-gray-500 text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
    <div id="staffSection" class="section hidden">
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b flex justify-between items-center">
          <h2 class="text-lg font-bold">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
          <button id="addStaffBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">
            + æ–°è¦è¿½åŠ 
          </button>
        </div>
        <div class="p-6">
          <div id="staffListManagement" class="space-y-4">
            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="staffModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
          <h3 class="text-xl font-bold" id="modalTitle">ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ </h3>
          <button onclick="closeStaffModal()" class="text-gray-500 hover:text-gray-700">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <form id="staffForm" class="p-6 space-y-6">
          <input type="hidden" id="staffId">
          
          <!-- åŸºæœ¬æƒ…å ± -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">åå‰ *</label>
            <input type="text" id="staffName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>

          <!-- å†™çœŸURL -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸURL</label>
            <input type="url" id="staffPhoto" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://example.com/photo.jpg">
            <p class="text-xs text-gray-500 mt-1">å†™çœŸã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</p>
          </div>

          <!-- æ‹…å½“ç¨®ç›® -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">æ‹…å½“ç¨®ç›® *</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="checkbox" value="ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰" class="specialty-checkbox mr-2">
                <span>ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" value="ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³" class="specialty-checkbox mr-2">
                <span>ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³</span>
              </label>
            </div>
          </div>

          <!-- å‹¤å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-3">å‹¤å‹™ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</label>
            <div class="space-y-3">
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="monday" class="day-checkbox mr-2">
                  <span>æœˆæ›œæ—¥</span>
                </label>
                <input type="time" id="mondayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="mondayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
              
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="tuesday" class="day-checkbox mr-2">
                  <span>ç«æ›œæ—¥</span>
                </label>
                <input type="time" id="tuesdayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="tuesdayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
              
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="wednesday" class="day-checkbox mr-2">
                  <span>æ°´æ›œæ—¥</span>
                </label>
                <input type="time" id="wednesdayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="wednesdayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
              
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="thursday" class="day-checkbox mr-2">
                  <span>æœ¨æ›œæ—¥</span>
                </label>
                <input type="time" id="thursdayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="thursdayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
              
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="friday" class="day-checkbox mr-2">
                  <span>é‡‘æ›œæ—¥</span>
                </label>
                <input type="time" id="fridayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="fridayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
              
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="saturday" class="day-checkbox mr-2">
                  <span>åœŸæ›œæ—¥</span>
                </label>
                <input type="time" id="saturdayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="saturdayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
              
              <div class="grid grid-cols-3 gap-3 items-center">
                <label class="flex items-center">
                  <input type="checkbox" id="sunday" class="day-checkbox mr-2">
                  <span>æ—¥æ›œæ—¥</span>
                </label>
                <input type="time" id="sundayStart" class="px-2 py-1 border border-gray-300 rounded">
                <input type="time" id="sundayEnd" class="px-2 py-1 border border-gray-300 rounded">
              </div>
            </div>
          </div>

          <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeStaffModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              ä¿å­˜
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <div id="scheduleSection" class="section hidden">
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
        </div>
        <div class="p-6">
          <div id="weeklySchedule">
            <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc, addDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDbcAHRmhBGfUoqpf-LzgyrPdSRmGeJtDU",
      authDomain: "asano-dance-school-8b670.firebaseapp.com",
      projectId: "asano-dance-school-8b670",
      storageBucket: "asano-dance-school-8b670.firebasestorage.app",
      messagingSenderId: "167959563019",
      appId: "1:167959563019:web:840229f09cbcf86ae3300e"
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±
    const staffData = {
      asano: {
        name: "æµ…é‡è‹±ä¹‹",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰"],
        schedule: {
          monday: { start: "11:00", end: "20:00" },
          tuesday: { start: "11:00", end: "20:00" },
          wednesday: { start: "11:00", end: "20:00" },
          thursday: { start: "11:00", end: "20:00" },
          friday: { start: "11:00", end: "20:00" }
        }
      },
      tsunokake: {
        name: "è§’æ›è‹±å…¸",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰"],
        schedule: {
          monday: { start: "12:00", end: "19:00" },
          friday: { start: "12:00", end: "19:00" }
        }
      },
      suzuki: {
        name: "éˆ´æœ¨å–„å­",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³"],
        schedule: {
          wednesday: { start: "12:00", end: "18:00" }
        }
      },
      hosaka: {
        name: "ç©‚å‚ ç¤¼",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰"],
        schedule: {
          monday: { start: "12:00", end: "19:00" },
          friday: { start: "14:30", end: "19:00" }
        }
      },
      mimoto: {
        name: "è¦‹å…ƒå…‹è‡³",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³"],
        schedule: {
          monday: { start: "12:00", end: "15:30" },
          friday: { start: "12:00", end: "15:30" }
        }
      },
      nakayama: {
        name: "ä»²å±± é ˜",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³"],
        schedule: {
          thursday: { start: "12:00", end: "14:30" }
        }
      }
    };

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('userEmail').textContent = user.email;
        loadDashboard();
      } else {
        window.location.href = 'admin-login.html';
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹?')) {
        await signOut(auth);
        window.location.href = 'admin-login.html';
      }
    });

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.nav-btn').forEach(b => {
          b.classList.remove('active', 'bg-blue-600', 'text-white');
          b.classList.add('text-gray-600', 'hover:bg-gray-100');
        });
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('text-gray-600', 'hover:bg-gray-100');

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
        const section = btn.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(section + 'Section').classList.remove('hidden');

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        if (section === 'calendar') loadCalendar();
        if (section === 'bookings') loadAllBookings();
        if (section === 'staff') loadStaffManagement();
        if (section === 'schedule') loadWeeklySchedule();
      });
    });

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é–¢é€£ã®å¤‰æ•°
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let allBookingsData = [];

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿
    async function loadCalendar() {
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      try {
        const bookingsQuery = query(collection(db, 'bookings'), orderBy('date', 'asc'));
        const querySnapshot = await getDocs(bookingsQuery);
        
        allBookingsData = [];
        querySnapshot.forEach((doc) => {
          allBookingsData.push({ id: doc.id, ...doc.data() });
        });

        renderCalendar();
        
      } catch (error) {
        console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    function renderCalendar() {
      const year = currentYear;
      const month = currentMonth;
      
      // æœˆã®è¡¨ç¤º
      const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
      document.getElementById('currentMonth').textContent = `${year}å¹´ ${monthNames[month]}`;
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      let html = '';
      
      // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      dayNames.forEach(day => {
        html += `<div class="text-center font-semibold text-gray-600 py-2">${day}</div>`;
      });
      
      // ç©ºç™½ã‚»ãƒ«ï¼ˆæœˆã®æœ€åˆã®æ›œæ—¥ã¾ã§ï¼‰
      for (let i = 0; i < firstDay; i++) {
        html += '<div class="aspect-square"></div>';
      }
      
      // æ—¥ä»˜ã‚»ãƒ«
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const bookingsOnDay = allBookingsData.filter(b => b.date === dateStr);
        const count = bookingsOnDay.length;
        
        const isToday = dateStr === new Date().toISOString().split('T')[0];
        const isSunday = (firstDay + day - 1) % 7 === 0;
        const isSaturday = (firstDay + day - 1) % 7 === 6;
        
        let bgColor = 'bg-white hover:bg-gray-50';
        let textColor = 'text-gray-800';
        
        if (isToday) {
          bgColor = 'bg-blue-50 hover:bg-blue-100';
          textColor = 'text-blue-600 font-bold';
        }
        if (isSunday) textColor = 'text-red-600';
        if (isSaturday) textColor = 'text-blue-600';
        
        html += `
          <div class="aspect-square border rounded-lg ${bgColor} cursor-pointer transition" onclick="showDayDetails('${dateStr}')">
            <div class="h-full flex flex-col p-2">
              <div class="${textColor} text-sm font-medium">${day}</div>
              ${count > 0 ? `
                <div class="flex-1 flex items-center justify-center">
                  <div class="bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">
                    ${count}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      
      document.getElementById('calendarGrid').innerHTML = html;
    }

    // æ—¥ä»˜ã®è©³ç´°ã‚’è¡¨ç¤º
    window.showDayDetails = function(dateStr) {
      const bookingsOnDay = allBookingsData.filter(b => b.date === dateStr);
      
      if (bookingsOnDay.length === 0) {
        document.getElementById('dayDetails').classList.add('hidden');
        return;
      }
      
      // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
      bookingsOnDay.sort((a, b) => a.time.localeCompare(b.time));
      
      // æ—¥ä»˜ã‚’æ•´å½¢
      const date = new Date(dateStr);
      const formatted = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ï¼ˆ${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()]}ï¼‰`;
      
      document.getElementById('selectedDate').textContent = formatted;
      
      let html = '<div class="space-y-3">';
      bookingsOnDay.forEach(booking => {
        html += `
          <div class="border rounded-lg p-4 hover:bg-gray-50">
            <div class="flex justify-between items-start mb-3">
              <div>
                <div class="font-semibold text-gray-800 mb-1">${booking.name}</div>
                <div class="text-sm text-gray-600">ğŸ“ ${booking.phone}</div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-blue-600">${booking.time}</div>
                <div class="text-sm text-gray-600">${booking.lessonType}</div>
              </div>
            </div>
            ${booking.message ? `<div class="mt-2 p-2 bg-yellow-50 rounded text-sm">ğŸ’¬ ${booking.message}</div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      
      document.getElementById('dayBookings').innerHTML = html;
      document.getElementById('dayDetails').classList.remove('hidden');
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      document.getElementById('dayDetails').scrollIntoView({ behavior: 'smooth', block: 'start' });
    };

    // å‰æœˆãƒ»æ¬¡æœˆãƒœã‚¿ãƒ³
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
      document.getElementById('dayDetails').classList.add('hidden');
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
      document.getElementById('dayDetails').classList.add('hidden');
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿
    async function loadDashboard() {
      try {
        const bookingsQuery = query(collection(db, 'bookings'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(bookingsQuery);
        
        const bookings = [];
        querySnapshot.forEach((doc) => {
          bookings.push({ id: doc.id, ...doc.data() });
        });

        // çµ±è¨ˆã‚’è¨ˆç®—
        const today = new Date().toISOString().split('T')[0];
        const todayBookings = bookings.filter(b => b.date === today);
        
        const now = new Date();
        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        const weekBookings = bookings.filter(b => {
          const bookingDate = new Date(b.date);
          return bookingDate >= weekStart && bookingDate <= weekEnd;
        });

        document.getElementById('todayBookings').textContent = todayBookings.length;
        document.getElementById('weekBookings').textContent = weekBookings.length;
        document.getElementById('totalBookings').textContent = bookings.length;

        // æœ€è¿‘ã®äºˆç´„ã‚’è¡¨ç¤º
        displayRecentBookings(bookings.slice(0, 5));
        
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æœ€è¿‘ã®äºˆç´„ã‚’è¡¨ç¤º
    function displayRecentBookings(bookings) {
      const container = document.getElementById('recentBookings');
      
      if (bookings.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = '<div class="space-y-4">';
      bookings.forEach(booking => {
        html += `
          <div class="border rounded-lg p-4 hover:bg-gray-50">
            <div class="flex justify-between items-start mb-2">
              <div class="font-semibold text-gray-800">${booking.name}</div>
              <div class="text-sm text-gray-500">${new Date(booking.createdAt).toLocaleDateString('ja-JP')}</div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
              <div>ğŸ“… ${booking.date} ${booking.time}</div>
              <div>ğŸ“š ${booking.lessonType}</div>
              <div>ğŸ“ ${booking.phone}</div>
              ${booking.email ? `<div>ğŸ“§ ${booking.email}</div>` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    // å…¨äºˆç´„ã‚’è¡¨ç¤º
    async function loadAllBookings() {
      try {
        const bookingsQuery = query(collection(db, 'bookings'), orderBy('date', 'asc'));
        const querySnapshot = await getDocs(bookingsQuery);
        
        const bookings = [];
        querySnapshot.forEach((doc) => {
          bookings.push({ id: doc.id, ...doc.data() });
        });

        const container = document.getElementById('allBookings');
        
        if (bookings.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-8">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        let html = '<div class="space-y-3">';
        bookings.forEach(booking => {
          html += `
            <div class="border rounded-lg p-4 hover:bg-gray-50">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <div class="font-semibold text-gray-800 mb-1">${booking.name}</div>
                  <div class="text-sm text-gray-600">ğŸ“ ${booking.phone}</div>
                  ${booking.email ? `<div class="text-sm text-gray-600">ğŸ“§ ${booking.email}</div>` : ''}
                </div>
                <button onclick="deleteBooking('${booking.id}')" class="text-red-600 hover:text-red-800 text-sm">
                  å‰Šé™¤
                </button>
              </div>
              <div class="grid grid-cols-3 gap-2 text-sm">
                <div class="bg-blue-50 p-2 rounded">
                  <div class="text-xs text-gray-600">æ—¥æ™‚</div>
                  <div class="font-medium">${booking.date} ${booking.time}</div>
                </div>
                <div class="bg-green-50 p-2 rounded">
                  <div class="text-xs text-gray-600">ãƒ¬ãƒƒã‚¹ãƒ³</div>
                  <div class="font-medium">${booking.lessonType}</div>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                  <div class="text-xs text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                  <div class="font-medium">${booking.status || 'ç¢ºå®š'}</div>
                </div>
              </div>
              ${booking.message ? `<div class="mt-3 p-2 bg-yellow-50 rounded text-sm">ğŸ’¬ ${booking.message}</div>` : ''}
            </div>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('äºˆç´„èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // äºˆç´„å‰Šé™¤
    window.deleteBooking = async function(bookingId) {
      if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
      
      try {
        await deleteDoc(doc(db, 'bookings', bookingId));
        alert('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadAllBookings();
        loadDashboard();
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆè¡¨ç¤º
    function loadStaffList() {
      const container = document.getElementById('staffList');
      let html = '';
      
      Object.entries(staffData).forEach(([id, staff]) => {
        const workDays = Object.keys(staff.schedule).map(day => {
          const dayNames = {
            monday: 'æœˆ', tuesday: 'ç«', wednesday: 'æ°´',
            thursday: 'æœ¨', friday: 'é‡‘', saturday: 'åœŸ', sunday: 'æ—¥'
          };
          return dayNames[day];
        }).join('ãƒ»');

        html += `
          <div class="border rounded-lg p-4">
            <div class="font-semibold text-gray-800 mb-2">${staff.name}</div>
            <div class="space-y-1 text-sm">
              <div class="text-gray-600">
                <span class="font-medium">æ‹…å½“:</span> ${staff.specialty.join('ãƒ»')}
              </div>
              <div class="text-gray-600">
                <span class="font-medium">å‹¤å‹™:</span> ${workDays}æ›œæ—¥
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†æ©Ÿèƒ½
    async function loadStaffManagement() {
      try {
        const staffQuery = query(collection(db, 'staff'));
        const querySnapshot = await getDocs(staffQuery);
        
        const container = document.getElementById('staffListManagement');
        
        if (querySnapshot.empty) {
          container.innerHTML = '<p class="text-gray-500 text-center py-8">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
          return;
        }

        let html = '';
        querySnapshot.forEach((doc) => {
          const staff = doc.data();
          const schedule = staff.schedule || {};
          const workDays = Object.keys(schedule).map(day => {
            const dayNames = {
              monday: 'æœˆ', tuesday: 'ç«', wednesday: 'æ°´',
              thursday: 'æœ¨', friday: 'é‡‘', saturday: 'åœŸ', sunday: 'æ—¥'
            };
            return dayNames[day];
          }).join('ãƒ»');

          html += `
            <div class="border rounded-lg p-4 flex items-start space-x-4">
              ${staff.photo ? `
                <img src="${staff.photo}" alt="${staff.name}" class="w-16 h-16 rounded-full object-cover">
              ` : `
                <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-2xl">
                  ${staff.name.charAt(0)}
                </div>
              `}
              <div class="flex-1">
                <h3 class="font-bold text-lg mb-1">${staff.name}</h3>
                <div class="text-sm text-gray-600 space-y-1">
                  <div><span class="font-medium">æ‹…å½“:</span> ${staff.specialty.join('ãƒ»')}</div>
                  <div><span class="font-medium">å‹¤å‹™:</span> ${workDays}æ›œæ—¥</div>
                </div>
              </div>
              <div class="flex flex-col space-y-2">
                <button onclick="editStaff('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                  ç·¨é›†
                </button>
                <button onclick="deleteStaff('${doc.id}', '${staff.name}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                  å‰Šé™¤
                </button>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('ã‚¹ã‚¿ãƒƒãƒ•èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
    window.openStaffModal = function() {
      document.getElementById('staffModal').classList.remove('hidden');
      document.getElementById('modalTitle').textContent = 'ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ';
      document.getElementById('staffForm').reset();
      document.getElementById('staffId').value = '';
    };

    window.closeStaffModal = function() {
      document.getElementById('staffModal').classList.add('hidden');
      document.getElementById('staffForm').reset();
    };

    // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒœã‚¿ãƒ³
    document.getElementById('addStaffBtn').addEventListener('click', openStaffModal);

    // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
    window.editStaff = async function(staffId) {
      try {
        const docRef = doc(db, 'staff', staffId);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const staff = docSnap.data();
          
          document.getElementById('staffId').value = staffId;
          document.getElementById('staffName').value = staff.name;
          document.getElementById('staffPhoto').value = staff.photo || '';
          
          // æ‹…å½“ç¨®ç›®
          document.querySelectorAll('.specialty-checkbox').forEach(cb => {
            cb.checked = staff.specialty.includes(cb.value);
          });
          
          // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
          days.forEach(day => {
            const checkbox = document.getElementById(day);
            const startInput = document.getElementById(day + 'Start');
            const endInput = document.getElementById(day + 'End');
            
            if (staff.schedule && staff.schedule[day]) {
              checkbox.checked = true;
              startInput.value = staff.schedule[day].start;
              endInput.value = staff.schedule[day].end;
            } else {
              checkbox.checked = false;
              startInput.value = '';
              endInput.value = '';
            }
          });
          
          document.getElementById('modalTitle').textContent = 'ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†';
          document.getElementById('staffModal').classList.remove('hidden');
        }
      } catch (error) {
        console.error('ã‚¹ã‚¿ãƒƒãƒ•èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    // ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤
    window.deleteStaff = async function(staffId, staffName) {
      if (!confirm(`${staffName} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      try {
        await deleteDoc(doc(db, 'staff', staffId));
        alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadStaffManagement();
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('staffForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const staffId = document.getElementById('staffId').value;
      const name = document.getElementById('staffName').value;
      const photo = document.getElementById('staffPhoto').value;
      
      // æ‹…å½“ç¨®ç›®
      const specialty = [];
      document.querySelectorAll('.specialty-checkbox:checked').forEach(cb => {
        specialty.push(cb.value);
      });
      
      if (specialty.length === 0) {
        alert('æ‹…å½“ç¨®ç›®ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      const schedule = {};
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      days.forEach(day => {
        const checkbox = document.getElementById(day);
        if (checkbox.checked) {
          const start = document.getElementById(day + 'Start').value;
          const end = document.getElementById(day + 'End').value;
          if (start && end) {
            schedule[day] = { start, end };
          }
        }
      });
      
      const staffData = {
        name,
        photo,
        specialty,
        schedule,
        updatedAt: new Date().toISOString()
      };
      
      try {
        if (staffId) {
          // æ›´æ–°
          await updateDoc(doc(db, 'staff', staffId), staffData);
          alert('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
          // æ–°è¦è¿½åŠ 
          staffData.createdAt = new Date().toISOString();
          await addDoc(collection(db, 'staff'), staffData);
          alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
        
        closeStaffModal();
        loadStaffManagement();
        
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
    function loadWeeklySchedule() {
      const container = document.getElementById('weeklySchedule');
      const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
      const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      
      let html = '<div class="space-y-6">';
      
      days.forEach((day, index) => {
        const dayKey = dayKeys[index];
        const staffOnDuty = Object.entries(staffData).filter(([id, staff]) => 
          staff.schedule[dayKey]
        );

        html += `
          <div class="border rounded-lg p-4">
            <h3 class="font-bold text-lg mb-3">${day}æ›œæ—¥</h3>
            ${staffOnDuty.length === 0 ? 
              '<p class="text-gray-500">å‹¤å‹™ã‚¹ã‚¿ãƒƒãƒ•ãªã—</p>' :
              '<div class="space-y-2">' +
              staffOnDuty.map(([id, staff]) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                  <div>
                    <div class="font-medium">${staff.name}</div>
                    <div class="text-sm text-gray-600">${staff.specialty.join('ãƒ»')}</div>
                  </div>
                  <div class="text-sm font-medium text-blue-600">
                    ${staff.schedule[dayKey].start} - ${staff.schedule[dayKey].end}
                  </div>
                </div>
              `).join('') +
              '</div>'
            }
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // åˆæœŸåŒ–æ™‚ã«activeã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
    document.querySelector('.nav-btn.active').classList.add('bg-blue-600', 'text-white');
  </script>
</body>
</html>
