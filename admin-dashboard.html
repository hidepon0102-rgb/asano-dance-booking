<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†ç”»é¢ - ã‚¢ã‚µãƒãƒ€ãƒ³ã‚¹ã‚¹ã‚¯ãƒ¼ãƒ«</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold text-gray-800">ã‚¢ã‚µãƒãƒ€ãƒ³ã‚¹ã‚¹ã‚¯ãƒ¼ãƒ«</h1>
        <p class="text-sm text-gray-600">ç®¡ç†ç”»é¢</p>
      </div>
      <div class="flex items-center space-x-4">
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="mb-8">
      <div class="flex space-x-1 bg-white rounded-lg p-1 shadow-sm">
        <button class="nav-btn active px-4 py-2 rounded-lg font-medium text-sm" data-section="dashboard">
          ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm" data-section="bookings">
          äºˆç´„ç®¡ç†
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm" data-section="staff">
          ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
        </button>
        <button class="nav-btn px-4 py-2 rounded-lg font-medium text-sm" data-section="schedule">
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        </button>
      </div>
    </nav>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div id="dashboardSection" class="section">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="text-sm text-gray-600 mb-2">ä»Šæ—¥ã®äºˆç´„</div>
          <div class="text-3xl font-bold text-blue-600" id="todayBookings">0</div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="text-sm text-gray-600 mb-2">ä»Šé€±ã®äºˆç´„</div>
          <div class="text-3xl font-bold text-green-600" id="weekBookings">0</div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
          <div class="text-sm text-gray-600 mb-2">ç·äºˆç´„æ•°</div>
          <div class="text-3xl font-bold text-gray-800" id="totalBookings">0</div>
        </div>
      </div>

      <!-- æœ€è¿‘ã®äºˆç´„ -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">æœ€è¿‘ã®äºˆç´„</h2>
        </div>
        <div id="recentBookings" class="p-6">
          <p class="text-gray-500 text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- äºˆç´„ç®¡ç† -->
    <div id="bookingsSection" class="section hidden">
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">äºˆç´„ä¸€è¦§</h2>
        </div>
        <div id="allBookings" class="p-6">
          <p class="text-gray-500 text-center py-8">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† -->
    <div id="staffSection" class="section hidden">
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="staffList">
            <!-- ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <div id="scheduleSection" class="section hidden">
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
          <h2 class="text-lg font-bold">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
        </div>
        <div class="p-6">
          <div id="weeklySchedule">
            <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDKã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDbcAHRmhBGfUoqpf-LzgyrPdSRmGeJtDU",
      authDomain: "asano-dance-school-8b670.firebaseapp.com",
      projectId: "asano-dance-school-8b670",
      storageBucket: "asano-dance-school-8b670.firebasestorage.app",
      messagingSenderId: "167959563019",
      appId: "1:167959563019:web:840229f09cbcf86ae3300e"
    };

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±
    const staffData = {
      asano: {
        name: "æµ…é‡è‹±ä¹‹",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰"],
        schedule: {
          monday: { start: "11:00", end: "20:00" },
          tuesday: { start: "11:00", end: "20:00" },
          wednesday: { start: "11:00", end: "20:00" },
          thursday: { start: "11:00", end: "20:00" },
          friday: { start: "11:00", end: "20:00" }
        }
      },
      tsunokake: {
        name: "è§’æ›è‹±å…¸",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰"],
        schedule: {
          monday: { start: "12:00", end: "19:00" },
          friday: { start: "12:00", end: "19:00" }
        }
      },
      suzuki: {
        name: "éˆ´æœ¨å–„å­",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³"],
        schedule: {
          wednesday: { start: "12:00", end: "18:00" }
        }
      },
      hosaka: {
        name: "ç©‚å‚ ç¤¼",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰"],
        schedule: {
          monday: { start: "12:00", end: "19:00" },
          friday: { start: "14:30", end: "19:00" }
        }
      },
      mimoto: {
        name: "è¦‹å…ƒå…‹è‡³",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³"],
        schedule: {
          monday: { start: "12:00", end: "15:30" },
          friday: { start: "12:00", end: "15:30" }
        }
      },
      nakayama: {
        name: "ä»²å±± é ˜",
        specialty: ["ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰", "ãƒ©ãƒ†ãƒ³ã‚¢ãƒ¡ãƒªã‚«ãƒ³"],
        schedule: {
          thursday: { start: "12:00", end: "14:30" }
        }
      }
    };

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('userEmail').textContent = user.email;
        loadDashboard();
      } else {
        window.location.href = 'admin-login.html';
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹?')) {
        await signOut(auth);
        window.location.href = 'admin-login.html';
      }
    });

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.nav-btn').forEach(b => {
          b.classList.remove('active', 'bg-blue-600', 'text-white');
          b.classList.add('text-gray-600', 'hover:bg-gray-100');
        });
        btn.classList.add('active', 'bg-blue-600', 'text-white');
        btn.classList.remove('text-gray-600', 'hover:bg-gray-100');

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
        const section = btn.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
        document.getElementById(section + 'Section').classList.remove('hidden');

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        if (section === 'bookings') loadAllBookings();
        if (section === 'staff') loadStaffList();
        if (section === 'schedule') loadWeeklySchedule();
      });
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿
    async function loadDashboard() {
      try {
        const bookingsQuery = query(collection(db, 'bookings'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(bookingsQuery);
        
        const bookings = [];
        querySnapshot.forEach((doc) => {
          bookings.push({ id: doc.id, ...doc.data() });
        });

        // çµ±è¨ˆã‚’è¨ˆç®—
        const today = new Date().toISOString().split('T')[0];
        const todayBookings = bookings.filter(b => b.date === today);
        
        const now = new Date();
        const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        const weekBookings = bookings.filter(b => {
          const bookingDate = new Date(b.date);
          return bookingDate >= weekStart && bookingDate <= weekEnd;
        });

        document.getElementById('todayBookings').textContent = todayBookings.length;
        document.getElementById('weekBookings').textContent = weekBookings.length;
        document.getElementById('totalBookings').textContent = bookings.length;

        // æœ€è¿‘ã®äºˆç´„ã‚’è¡¨ç¤º
        displayRecentBookings(bookings.slice(0, 5));
        
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æœ€è¿‘ã®äºˆç´„ã‚’è¡¨ç¤º
    function displayRecentBookings(bookings) {
      const container = document.getElementById('recentBookings');
      
      if (bookings.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = '<div class="space-y-4">';
      bookings.forEach(booking => {
        html += `
          <div class="border rounded-lg p-4 hover:bg-gray-50">
            <div class="flex justify-between items-start mb-2">
              <div class="font-semibold text-gray-800">${booking.name}</div>
              <div class="text-sm text-gray-500">${new Date(booking.createdAt).toLocaleDateString('ja-JP')}</div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
              <div>ğŸ“… ${booking.date} ${booking.time}</div>
              <div>ğŸ“š ${booking.lessonType}</div>
              <div>ğŸ“ ${booking.phone}</div>
              ${booking.email ? `<div>ğŸ“§ ${booking.email}</div>` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      container.innerHTML = html;
    }

    // å…¨äºˆç´„ã‚’è¡¨ç¤º
    async function loadAllBookings() {
      try {
        const bookingsQuery = query(collection(db, 'bookings'), orderBy('date', 'asc'));
        const querySnapshot = await getDocs(bookingsQuery);
        
        const bookings = [];
        querySnapshot.forEach((doc) => {
          bookings.push({ id: doc.id, ...doc.data() });
        });

        const container = document.getElementById('allBookings');
        
        if (bookings.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center py-8">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        let html = '<div class="space-y-3">';
        bookings.forEach(booking => {
          html += `
            <div class="border rounded-lg p-4 hover:bg-gray-50">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <div class="font-semibold text-gray-800 mb-1">${booking.name}</div>
                  <div class="text-sm text-gray-600">ğŸ“ ${booking.phone}</div>
                  ${booking.email ? `<div class="text-sm text-gray-600">ğŸ“§ ${booking.email}</div>` : ''}
                </div>
                <button onclick="deleteBooking('${booking.id}')" class="text-red-600 hover:text-red-800 text-sm">
                  å‰Šé™¤
                </button>
              </div>
              <div class="grid grid-cols-3 gap-2 text-sm">
                <div class="bg-blue-50 p-2 rounded">
                  <div class="text-xs text-gray-600">æ—¥æ™‚</div>
                  <div class="font-medium">${booking.date} ${booking.time}</div>
                </div>
                <div class="bg-green-50 p-2 rounded">
                  <div class="text-xs text-gray-600">ãƒ¬ãƒƒã‚¹ãƒ³</div>
                  <div class="font-medium">${booking.lessonType}</div>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                  <div class="text-xs text-gray-600">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                  <div class="font-medium">${booking.status || 'ç¢ºå®š'}</div>
                </div>
              </div>
              ${booking.message ? `<div class="mt-3 p-2 bg-yellow-50 rounded text-sm">ğŸ’¬ ${booking.message}</div>` : ''}
            </div>
          `;
        });
        html += '</div>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('äºˆç´„èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // äºˆç´„å‰Šé™¤
    window.deleteBooking = async function(bookingId) {
      if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
      
      try {
        await deleteDoc(doc(db, 'bookings', bookingId));
        alert('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadAllBookings();
        loadDashboard();
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆè¡¨ç¤º
    function loadStaffList() {
      const container = document.getElementById('staffList');
      let html = '';
      
      Object.entries(staffData).forEach(([id, staff]) => {
        const workDays = Object.keys(staff.schedule).map(day => {
          const dayNames = {
            monday: 'æœˆ', tuesday: 'ç«', wednesday: 'æ°´',
            thursday: 'æœ¨', friday: 'é‡‘', saturday: 'åœŸ', sunday: 'æ—¥'
          };
          return dayNames[day];
        }).join('ãƒ»');

        html += `
          <div class="border rounded-lg p-4">
            <div class="font-semibold text-gray-800 mb-2">${staff.name}</div>
            <div class="space-y-1 text-sm">
              <div class="text-gray-600">
                <span class="font-medium">æ‹…å½“:</span> ${staff.specialty.join('ãƒ»')}
              </div>
              <div class="text-gray-600">
                <span class="font-medium">å‹¤å‹™:</span> ${workDays}æ›œæ—¥
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ç¤º
    function loadWeeklySchedule() {
      const container = document.getElementById('weeklySchedule');
      const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
      const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      
      let html = '<div class="space-y-6">';
      
      days.forEach((day, index) => {
        const dayKey = dayKeys[index];
        const staffOnDuty = Object.entries(staffData).filter(([id, staff]) => 
          staff.schedule[dayKey]
        );

        html += `
          <div class="border rounded-lg p-4">
            <h3 class="font-bold text-lg mb-3">${day}æ›œæ—¥</h3>
            ${staffOnDuty.length === 0 ? 
              '<p class="text-gray-500">å‹¤å‹™ã‚¹ã‚¿ãƒƒãƒ•ãªã—</p>' :
              '<div class="space-y-2">' +
              staffOnDuty.map(([id, staff]) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded">
                  <div>
                    <div class="font-medium">${staff.name}</div>
                    <div class="text-sm text-gray-600">${staff.specialty.join('ãƒ»')}</div>
                  </div>
                  <div class="text-sm font-medium text-blue-600">
                    ${staff.schedule[dayKey].start} - ${staff.schedule[dayKey].end}
                  </div>
                </div>
              `).join('') +
              '</div>'
            }
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // åˆæœŸåŒ–æ™‚ã«activeã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
    document.querySelector('.nav-btn.active').classList.add('bg-blue-600', 'text-white');
  </script>
</body>
</html>
